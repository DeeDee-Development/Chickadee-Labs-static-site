---
// Password-protected content gate
// Uses SHA-256 hash to verify password without storing it in plaintext
const { pageId } = Astro.props;
---

<div id="password-gate" class="password-gate">
  <div class="password-gate-content">
    <div class="password-gate-icon">ðŸ”’</div>
    <h2>Protected Content</h2>
    <p>This page requires a password to view.</p>
    <form id="password-form" class="password-form">
      <input
        type="password"
        id="password-input"
        placeholder="Enter password"
        autocomplete="off"
        required
      />
      <button type="submit" class="btn btn-primary">Unlock</button>
    </form>
    <div id="password-error" class="password-error"></div>
  </div>
</div>

<div id="protected-content" class="protected-content" style="display: none;">
  <slot />
</div>

<style>
  .password-gate {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease;
  }

  .password-gate-content {
    background: white;
    border-radius: 16px;
    padding: 3rem;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    text-align: center;
  }

  .password-gate-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
  }

  .password-gate-content h2 {
    margin-bottom: 0.5rem;
    color: #1a1a1a;
  }

  .password-gate-content p {
    color: #666;
    margin-bottom: 2rem;
  }

  .password-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .password-form input {
    padding: 0.75rem 1rem;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.2s ease;
  }

  .password-form input:focus {
    outline: none;
    border-color: #0066EE;
  }

  .password-form button {
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
  }

  .password-error {
    color: #f44336;
    font-size: 0.875rem;
    margin-top: 1rem;
    min-height: 1.5rem;
  }

  .protected-content {
    animation: fadeIn 0.5s ease;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes fadeOut {
    from {
      opacity: 1;
    }
    to {
      opacity: 0;
    }
  }
</style>

<script define:vars={{ pageId }}>
  // Password hash (SHA-256)
  // To change: Run `node generate-password-hash.js` and replace this hash
  const PASSWORD_HASH = 'e004419ae20083c7e67d7b728d2e1bb2e5f93ef450abebb96653900f1e9f0499';

  async function hashPassword(password) {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    return hashHex;
  }

  async function checkPassword(password) {
    const hash = await hashPassword(password);
    return hash === PASSWORD_HASH;
  }

  function unlockContent() {
    const gate = document.getElementById('password-gate');
    const content = document.getElementById('protected-content');

    if (gate && content) {
      gate.style.animation = 'fadeOut 0.3s ease';
      setTimeout(() => {
        gate.style.display = 'none';
        content.style.display = 'block';
      }, 300);
    }
  }

  function showError(message) {
    const errorDiv = document.getElementById('password-error');
    if (errorDiv) {
      errorDiv.textContent = message;
      setTimeout(() => {
        errorDiv.textContent = '';
      }, 3000);
    }
  }

  // Handle form submission
  const form = document.getElementById('password-form');
  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const input = document.getElementById('password-input');
      const password = input.value;

      if (await checkPassword(password)) {
        unlockContent();
      } else {
        showError('Incorrect password. Please try again.');
        input.value = '';
        input.focus();
      }
    });
  }
</script>
